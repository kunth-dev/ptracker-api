name: Deploy to Remote Server

on:
  workflow_dispatch:

jobs:
  validate-secrets:
    name: Validate Required Secrets
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Check required secrets are configured
        env:
          SERVER_SSH_HOST: ${{ secrets.SERVER_SSH_HOST }}
          SERVER_SSH_LOGIN: ${{ secrets.SERVER_SSH_LOGIN }}
          SERVER_SSH_PASSWORD: ${{ secrets.SERVER_SSH_PASSWORD }}
          BEARER_TOKENS: ${{ secrets.BEARER_TOKENS }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          DRIZZLE_GATEWAY_MASTERPASS: ${{ secrets.DRIZZLE_GATEWAY_MASTERPASS }}
          SMTP_APP_PASS: ${{ secrets.SMTP_APP_PASS }}
          SSL_EMAIL: ${{ secrets.SSL_EMAIL }}
        run: |
          error_found=false
          
          if [ -z "$SERVER_SSH_HOST" ]; then
            echo "::error::SECRET 'SERVER_SSH_HOST' is not configured. Please add it in Settings > Secrets and variables > Actions > Secrets"
            error_found=true
          fi
          
          if [ -z "$SERVER_SSH_LOGIN" ]; then
            echo "::error::SECRET 'SERVER_SSH_LOGIN' is not configured. Please add it in Settings > Secrets and variables > Actions > Secrets"
            error_found=true
          fi
          
          if [ -z "$SERVER_SSH_PASSWORD" ]; then
            echo "::error::SECRET 'SERVER_SSH_PASSWORD' is not configured. Please add it in Settings > Secrets and variables > Actions > Secrets"
            error_found=true
          fi
          
          if [ -z "$BEARER_TOKENS" ]; then
            echo "::error::SECRET 'BEARER_TOKENS' is not configured. Please add it in Settings > Secrets and variables > Actions > Secrets"
            error_found=true
          fi
          
          if [ -z "$POSTGRES_PASSWORD" ]; then
            echo "::error::SECRET 'POSTGRES_PASSWORD' is not configured. Please add it in Settings > Secrets and variables > Actions > Secrets"
            error_found=true
          fi
          
          if [ -z "$DRIZZLE_GATEWAY_MASTERPASS" ]; then
            echo "::error::SECRET 'DRIZZLE_GATEWAY_MASTERPASS' is not configured. Please add it in Settings > Secrets and variables > Actions > Secrets"
            error_found=true
          fi
          
          if [ -z "$SSL_EMAIL" ]; then
            echo "::error::SECRET 'SSL_EMAIL' is not configured. Please add it in Settings > Secrets and variables > Actions > Secrets"
            error_found=true
          fi
          
          if [ -z "$SMTP_APP_PASS" ]; then
            echo "::warning::SECRET 'SMTP_APP_PASS' is not configured. SMTP email sending will be disabled."
          fi
          
          if [ "$error_found" = true ]; then
            echo ""
            echo "=========================================="
            echo "DEPLOYMENT FAILED: Missing Required Secrets"
            echo "=========================================="
            echo ""
            echo "Please configure the missing secrets in your GitHub repository:"
            echo "1. Go to Settings > Secrets and variables > Actions > Secrets"
            echo "2. Click 'New repository secret'"
            echo "3. Add each missing secret listed above"
            echo ""
            echo "For detailed setup instructions, see:"
            echo "- docs/GITHUB_SETUP.md"
            echo "- docs/DEPLOYMENT.md"
            echo ""
            exit 1
          fi
          
          echo "✅ All required secrets are configured"
  
  deploy:
    name: Deploy API to Remote Server
    runs-on: ubuntu-latest
    needs: validate-secrets
    permissions:
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Create deployment directory on remote server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_SSH_HOST }}
          username: ${{ secrets.SERVER_SSH_LOGIN }}
          password: ${{ secrets.SERVER_SSH_PASSWORD }}
          script: |
            mkdir -p /var/www/ptracker-api
            mkdir -p /var/www/ptracker-api/logs
      
      - name: Copy files to remote server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_SSH_HOST }}
          username: ${{ secrets.SERVER_SSH_LOGIN }}
          password: ${{ secrets.SERVER_SSH_PASSWORD }}
          source: "."
          target: /var/www/ptracker-api
          strip_components: 0
          overwrite: true
          rm: true
      
      - name: Create .env file on remote server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_SSH_HOST }}
          username: ${{ secrets.SERVER_SSH_LOGIN }}
          password: ${{ secrets.SERVER_SSH_PASSWORD }}
          script: |
            cd /var/www/ptracker-api
            cat > .env << 'EOF'
            PORT=${{ vars.PORT || '3002' }}
            NODE_ENV=${{ vars.NODE_ENV || 'production' }}
            ALLOWED_DOMAINS=${{ vars.ALLOWED_DOMAINS }}
            BEARER_TOKENS=${{ secrets.BEARER_TOKENS }}
            LOG_SECURITY_EVENTS=${{ vars.LOG_SECURITY_EVENTS || 'true' }}
            TRUST_PROXY=${{ vars.TRUST_PROXY || 'true' }}
            POSTGRES_DB=${{ vars.POSTGRES_DB || 'price_tracker_db' }}
            POSTGRES_USER=${{ vars.POSTGRES_USER || 'postgres_user' }}
            POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
            DRIZZLE_GATEWAY_MASTERPASS=${{ secrets.DRIZZLE_GATEWAY_MASTERPASS }}
            APP_DOMAIN=${{ vars.APP_DOMAIN || 'http://localhost:3002' }}
            API_DOMAIN=${{ vars.API_DOMAIN || 'api.khdev.ru' }}
            STUDIO_DOMAIN=${{ vars.STUDIO_DOMAIN || 'studio.khdev.ru' }}
            SSL_EMAIL=${{ secrets.SSL_EMAIL }}
            EOF
            
            # Only add SMTP configuration if all required variables are set
            if [ -n "${{ vars.SMTP_HOST }}" ] && [ -n "${{ vars.SMTP_PORT }}" ] && [ -n "${{ vars.SMTP_MAIL }}" ] && [ -n "${{ secrets.SMTP_APP_PASS }}" ]; then
              cat >> .env << 'EOF'
            SMTP_HOST=${{ vars.SMTP_HOST }}
            SMTP_PORT=${{ vars.SMTP_PORT }}
            SMTP_MAIL=${{ vars.SMTP_MAIL }}
            SMTP_APP_PASS=${{ secrets.SMTP_APP_PASS }}
            EOF
              echo "✅ SMTP configuration added to .env"
            else
              echo "⚠️  SMTP configuration incomplete - email sending will be disabled"
              echo "   Missing variables will be logged during deployment"
            fi
      
      - name: Deploy with Docker Compose
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_SSH_HOST }}
          username: ${{ secrets.SERVER_SSH_LOGIN }}
          password: ${{ secrets.SERVER_SSH_PASSWORD }}
          script: |
            cd /var/www/ptracker-api
            
            # Check if SSL certificates exist
            if [ ! -d "./certbot/conf/live/${{ vars.API_DOMAIN || 'api.khdev.ru' }}" ]; then
              echo "SSL certificates not found. Initializing..."
              
              # Create certbot directories
              mkdir -p certbot/conf certbot/www
              
              # Create dummy certificates for initial nginx startup
              mkdir -p certbot/conf/live/${{ vars.API_DOMAIN || 'api.khdev.ru' }}
              mkdir -p certbot/conf/live/${{ vars.STUDIO_DOMAIN || 'studio.khdev.ru' }}
              
              openssl req -x509 -nodes -newkey rsa:2048 -days 1 \
                -keyout certbot/conf/live/${{ vars.API_DOMAIN || 'api.khdev.ru' }}/privkey.pem \
                -out certbot/conf/live/${{ vars.API_DOMAIN || 'api.khdev.ru' }}/fullchain.pem \
                -subj "/CN=${{ vars.API_DOMAIN || 'api.khdev.ru' }}"
              
              cp certbot/conf/live/${{ vars.API_DOMAIN || 'api.khdev.ru' }}/fullchain.pem \
                 certbot/conf/live/${{ vars.API_DOMAIN || 'api.khdev.ru' }}/chain.pem
              
              openssl req -x509 -nodes -newkey rsa:2048 -days 1 \
                -keyout certbot/conf/live/${{ vars.STUDIO_DOMAIN || 'studio.khdev.ru' }}/privkey.pem \
                -out certbot/conf/live/${{ vars.STUDIO_DOMAIN || 'studio.khdev.ru' }}/fullchain.pem \
                -subj "/CN=${{ vars.STUDIO_DOMAIN || 'studio.khdev.ru' }}"
              
              cp certbot/conf/live/${{ vars.STUDIO_DOMAIN || 'studio.khdev.ru' }}/fullchain.pem \
                 certbot/conf/live/${{ vars.STUDIO_DOMAIN || 'studio.khdev.ru' }}/chain.pem
              
              # Start nginx to serve ACME challenges
              docker-compose up -d nginx
              sleep 10
              
              # Request real certificates
              echo "Requesting SSL certificate for ${{ vars.API_DOMAIN || 'api.khdev.ru' }}..."
              docker-compose run --rm certbot certonly \
                --webroot \
                --webroot-path=/var/www/certbot \
                --email ${{ secrets.SSL_EMAIL }} \
                --agree-tos \
                --no-eff-email \
                --force-renewal \
                -d ${{ vars.API_DOMAIN || 'api.khdev.ru' }} || echo "⚠️  Failed to obtain SSL certificate for API domain"
              
              echo "Requesting SSL certificate for ${{ vars.STUDIO_DOMAIN || 'studio.khdev.ru' }}..."
              docker-compose run --rm certbot certonly \
                --webroot \
                --webroot-path=/var/www/certbot \
                --email ${{ secrets.SSL_EMAIL }} \
                --agree-tos \
                --no-eff-email \
                --force-renewal \
                -d ${{ vars.STUDIO_DOMAIN || 'studio.khdev.ru' }} || echo "⚠️  Failed to obtain SSL certificate for Studio domain"
              
              echo "✅ SSL certificates initialized"
            else
              echo "SSL certificates already exist"
            fi
            
            # Deploy all services
            docker-compose down
            docker-compose up -d --build
            docker-compose ps
      
      - name: Verify Deployment
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_SSH_HOST }}
          username: ${{ secrets.SERVER_SSH_LOGIN }}
          password: ${{ secrets.SERVER_SSH_PASSWORD }}
          script: |
            cd /var/www/ptracker-api
            echo "Checking container status..."
            docker-compose ps
            
            echo "Checking API health..."
            docker-compose logs --tail=50 backend
            
            echo "Deployment completed!"
